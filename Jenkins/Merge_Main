pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'docker.io'  
        DOCKER_IMAGE = 'manikandan29/assignment'   // Docker image names must be lowercase
        DOCKER_CREDENTIALS = credentials('dockerhub-creds')
    }

    stages {

        stage('Checkout Code') {
            steps {
                script {
                    echo 'Checking out code from GitHub...'
                    git branch: 'main', url: 'https://github.com/Manikandan2907/Assignment-App.git'
                }
            }
        }

        stage('Build, Scan, and Push Docker Image') {
            steps {
                script {
                    def imageTag = "${env.BUILD_NUMBER}"  // Safer than GIT_COMMIT (can be null)
                    env.IMAGE_TAG = imageTag

                    echo "Building Docker Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    sh "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."

                    echo 'Scanning Docker Image for vulnerabilities using Trivy...'
                    sh "trivy image --exit-code 0 --severity HIGH,CRITICAL ${DOCKER_IMAGE}:${IMAGE_TAG}"

                    echo 'Pushing Docker Image to DockerHub...'
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                        sh """
                            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
                            docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${IMAGE_TAG}
                        """
                    }
                }
            }
        }
    }
}
